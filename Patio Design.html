<h1 style="text-align:center"> Patio Design </h1>
<hr>
<div id="container" style="float:left; margin:3px; width:60vw; height:40vw">
</div>

<div style="float:left; margin-left: 10px; width:32vw;">

  <div>
    Sphere radius:
    <input id="radius" type="range" min=3 max=30 value=5>
    <span id='radiusPrint'>
</span>
    <br>
  </div>
  <br>
  <div style='background-color:#FFE8BF'>
    Selector:
    <br>
	<label>
    <input type=radio name='create' class='create' value='chair' checked>chair
	</label>
	<label>
    <input type=radio name='create' class='create' value='table'>table
	</label>
  </div>
  <br>
  <button id='clear' style="width:45%">Clear</button>
  <button id='save' style="width:45%">Save</button>
  <button id='restore' style="width:45%">Restore</button>
</div>

<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://threejs.org/build/three.min.js"></script>
<script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>
<script>
$('#radius').change(function() {
  //$('#radiusPrint').text($(this).val());
});
var camera, scene, renderer, controls;
var raycaster = new THREE.Raycaster();
var mouse = new THREE.Vector2();
var pickplane;
var cyl, objects = new THREE.Group();
var chairs = [], tables = [], pickables = [];

init();
animate();

$('#clear').click(function() {

  chairs.forEach(function(chairGroup) {
    scene.remove(chairGroup);
  });
  tables.forEach(function(tableGroup) {
    scene.remove(tableGroup);
  });
  chairs = [];
  tables = [];
});

$('#save').click(function() {

  var states = [];
  chairs.forEach(function(chairGroup) {
    states.push(chairGroup.name);
  });
  tables.forEach(function(tableGroup) {
    states.push(tableGroup.name);
  });
  localStorage.setItem('stateStr', JSON.stringify(states));

});

$('#restore').click(function() {

  var states = JSON.parse(localStorage.getItem('stateStr'));
  states.forEach(function(stateStr) {
    //console.log(stateStr);
    var state = JSON.parse(stateStr);
	if($('input[class=create]:radio:checked').val() === 'chair')
		buildChair(state.rad, new THREE.Vector3(state.pos[0], 0, state.pos[1]));
	if($('input[class=create]:radio:checked').val() === 'table')
		buildTable(state.rad, new THREE.Vector3(state.pos[0], 0, state.pos[1]));
  });

});

function buildChair(rad, pos) {
	let texture = new THREE.TextureLoader().load('https://i.imgur.com/DrvlmNW.jpg');
	
	var chairGroup = new THREE.Group();
	var chairTop = new THREE.Mesh(new THREE.BoxGeometry(26, 3, 26), new THREE.MeshBasicMaterial({map: texture}));
	var chairLeg = new THREE.Mesh(new THREE.BoxGeometry(5.9, 41.5, 3), new THREE.MeshBasicMaterial({map: texture}));
	var chairLeg1 = new THREE.Mesh(new THREE.BoxGeometry(15.5, 4.5, 3), new THREE.MeshBasicMaterial({map: texture}));
	
	chairLeg1.rotation.y = Math.PI/4;
	//chairLeg.rotation.y = Math.PI/4;
	
	chairTop.position.set(0, 41, 0);
	chairLeg.position.set(-12.5, 20.5, 0);
	chairLeg1.position.set(0, 15.5, 0);
	
	let a = 1/Math.tan(Math.PI/3)
	localX = new THREE.Vector3(1, 0, 0)
	localY = new THREE.Vector3(a, 1, 0)
	localZ = new THREE.Vector3(0, 0, 1)
	chairLeg.matrix.makeBasis (localX, localY, localZ);
	chairLeg.matrixAutoUpdate = false;
	
	chairGroup.add(chairTop, chairLeg, chairLeg1);
	//chairGroup.position.set(-12.5, 41, 0);
	scene.add(chairGroup);
	

	var prop = {
		//rad: rad,
		pos: [pos.x, pos.z]
	};
	chairGroup.name = JSON.stringify(prop);
	chairs.push(chairGroup);
	pickables.push(chairGroup);
	chairGroup.position.copy(pos);
	
/*
  var sphere = new THREE.Mesh(new THREE.SphereGeometry(rad, 20, 20), new THREE.MeshNormalMaterial());

  scene.add(sphere);
  var prop = {
    rad: rad,
    pos: [pos.x, pos.z]
  };
  console.log(prop);
  sphere.name = JSON.stringify(prop);
  console.log(sphere.name);

  spheres.push(sphere);
  sphere.position.copy(pos);
*/
}

function buildTable(rad, pos) {
	let texture = new THREE.TextureLoader().load('https://i.imgur.com/DrvlmNW.jpg');
	
	var tableGroup = new THREE.Group();
	var tableTop = new THREE.Mesh(new THREE.BoxGeometry(40, 3, 40), new THREE.MeshBasicMaterial({map: texture}));
	var tableLeg = new THREE.Mesh(new THREE.BoxGeometry(5.9, 41.5, 3), new THREE.MeshBasicMaterial({map: texture}));
	var tableBottom = new THREE.Mesh(new THREE.BoxGeometry(15.5, 4.5, 3), new THREE.MeshBasicMaterial({map: texture}));
	
	tableTop.position.set(0, 41, 0);
	tableLeg.position.set(-12.5, 20.5, 0);
	tableBottom.position.set(0, 15.5, 0);
	
	tableGroup.add(tableTop, tableLeg, tableBottom);
	scene.add(tableGroup);
	

	var prop = {
		//rad: rad,
		pos: [pos.x, pos.z]
	};
	tableGroup.name = JSON.stringify(prop);
	tables.push(tableGroup);
	pickables.push(tableGroup);
	tableGroup.position.copy(pos);

}

function init() {

  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();
  renderer = new THREE.WebGLRenderer();
  renderer.setSize(ww, hh);
  renderer.setClearColor(0x888888);
  $("#container").append(renderer.domElement);

  ////////////////////////////////////////////////

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(50, ww / hh, 1, 1000);
  camera.position.z = 500;
  scene.add(camera);

  var cyl_geom = new THREE.RingGeometry(5, 10, 32);
  var cyl_mat = new THREE.MeshBasicMaterial({
    color: 0xff1234,
  });
  cyl = new THREE.Mesh(cyl_geom, cyl_mat);
  cyl.rotation.x = -Math.PI/2;
  cyl.position.set(-20, 0, 20);
  scene.add(cyl);

  pickplane = new THREE.Mesh(new THREE.PlaneGeometry(200, 200),
    new THREE.MeshBasicMaterial({
      color: 0xff1234
    }));
  pickplane.rotation.x = -Math.PI / 2;
  scene.add(pickplane);
  pickplane.material.visible = false;

  var gridXZ = new THREE.GridHelper(200, 20, 'red', 'white');
  scene.add(gridXZ);

  controls = new THREE.OrbitControls(camera, renderer.domElement);
  window.addEventListener('resize', onWindowResize, false);
  window.addEventListener('pointermove', onDocumentMouseMove, false);
  window.addEventListener('pointerdown', onDocumentMouseDown, false);

}

function onWindowResize() {
  var ww = $("#container").innerWidth();
  var hh = $("#container").innerHeight();

  camera.aspect = ww / hh;
  camera.updateProjectionMatrix();
  renderer.setSize(ww, hh);
}

function onDocumentMouseMove(event) {

  event.preventDefault();

  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  var intersects = raycaster.intersectObject(pickplane);
  var intersects1 = raycaster.intersectObjects(pickables, true);

  if (intersects.length > 0) {
	document.body.style.cursor = 'pointer';
    cyl.position.copy(intersects[0].point);
    cyl.position.y = 2;
  }else{
	document.body.style.cursor = 'auto';
  }
  if (intersects1.length > 0) {
	document.body.style.cursor = 'pointer';
    cyl.position.copy(intersects1[0].point);
    cyl.position.y = 2;
  }else{
	document.body.style.cursor = 'auto';
  }
  
}

function onDocumentMouseDown(event) {

  event.preventDefault();

  var viewportPos = $('#container').get(0).getBoundingClientRect();
  mouse.x = ((event.clientX - viewportPos.left) / $('#container').innerWidth()) * 2 - 1;
  mouse.y = -((event.clientY - viewportPos.top) / $('#container').innerHeight()) * 2 + 1;

  raycaster.setFromCamera(mouse, camera);
  var intersects = raycaster.intersectObject(pickplane);
  var intersects1 = raycaster.intersectObjects(pickables, true);
  if (intersects1.length > 0) {
    cyl.position.copy(intersects1[0].point);
	//intersects[0].object

	intersects1[0].object.position.copy(intersects[0].point);
	
  }if (intersects.length > 0) {
    cyl.position.copy(intersects[0].point);
	if($('input[class=create]:radio:checked').val() === 'chair')
		buildChair(10, intersects[0].point);
	if($('input[class=create]:radio:checked').val() === 'table')
		buildTable(10, intersects[0].point);
  }
}

function animate() {

  controls.update();
  requestAnimationFrame(animate);
  render();
}

function render() {
  renderer.render(scene, camera);
}
</script>